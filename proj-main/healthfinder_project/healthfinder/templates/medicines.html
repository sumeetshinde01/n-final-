<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medicine Availability | HealthFinder</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .medicine-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .medicine-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      .search-container {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
      }
      .availability-badge {
        font-size: 0.8rem;
        padding: 5px 10px;
      }
      .pharmacy-info {
        font-size: 0.9rem;
      }
      .pharmacy-option {
        transition: all 0.3s ease;
        border: none;
        border-radius: 8px;
        margin-bottom: 8px;
        background: linear-gradient(135deg, #e9edf2ff 0%, #e9ecef 100%);
        border-left: 4px solid transparent;
      }
      .pharmacy-option:hover {
        transform: translateX(5px);
        border-left-color: #0d6efd;
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .modal.fade .modal-dialog {
        transform: translateY(-50px);
        transition: transform 0.3s ease-out;
      }
      .modal.show .modal-dialog {
        transform: translateY(0);
      }
      .pharmacy-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
      }
      .pharmacy-1mg .pharmacy-icon {
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      }
      .pharmacy-pharmeasy .pharmacy-icon {
        background: linear-gradient(135deg, #4ecdc4, #44a08d);
      }
      .pharmacy-netmeds .pharmacy-icon {
        background: linear-gradient(135deg, #45b7d1, #3498db);
      }
      .pharmacy-apollo .pharmacy-icon {
        background: linear-gradient(135deg, #96ceb4, #7bcba7);
      }
      .distance-loading {
        color: #6c757d;
        font-style: italic;
      }
      .price-loading {
        color: #6c757d;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="/">HealthFinder</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/medicines">Medicines</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/hospitals">Hospitals</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/pharmacies">Pharmacies</a>
            </li>
          </ul>
          <div class="d-flex">
            <a href="/login" class="btn btn-outline-light me-2">Login</a>
            <a href="/register" class="btn btn-light">Register</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-5">
      <h1 class="mb-4">Medicine Availability</h1>

      <!-- Search Section -->
      <div class="search-container shadow-sm">
        <form action="/medicines" method="get">
          <div class="row">
            <div class="col-md-8">
              <div class="input-group mb-3">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Search for medicines..."
                  id="medicineSearch"
                  name="query"
                  value="{{ search_query }}"
                />
                <button class="btn btn-primary" type="submit">
                  <i class="fas fa-search"></i> Search
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <select class="form-select" id="locationFilter" name="location">
                <option value="all" selected>All locations</option>
                <option value="5">Nearby (5 km)</option>
                <option value="10">Within 10 km</option>
                <option value="20">Within 20 km</option>
              </select>
            </div>
          </div>
        </form>
      </div>

      <!-- Medicines List -->
      <div class="row row-cols-1 row-cols-md-3 g-4" id="medicinesList">
        {% for medicine in medicines %}
        <div class="col">
          <div class="card h-100 medicine-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <h5 class="card-title">{{ medicine.name }}</h5>
                <span class="badge bg-success availability-badge stock-status"
                  >In Stock</span
                >
              </div>
              <p class="card-text">{{ medicine.description }}</p>
              <p class="card-text">
                <strong>Category:</strong> {{ medicine.category }}
              </p>
              <p class="card-text">
                <strong>Price:</strong>
                <span class="price-value">â‚¹{{ medicine.price }}</span>
                <span class="price-loading" style="display: none"
                  >Checking prices...</span
                >
              </p>
              <p class="card-text">
                <strong>Manufacturer:</strong> {{ medicine.manufacturer }}
              </p>
              {% if medicine.prescription_required %}
              <p class="card-text">
                <span class="badge bg-warning">Prescription Required</span>
              </p>
              {% endif %}
              <hr />
              <div class="pharmacy-info">
                <p class="mb-1"><strong>Available at:</strong></p>
                <ul class="list-unstyled" id="pharmacies-{{ medicine.id }}">
                  <li>
                    <i class="fas fa-store text-primary me-2"></i>
                    <span class="distance-loading"
                      >Calculating distance...</span
                    >
                  </li>
                  <li>
                    <i class="fas fa-store text-primary me-2"></i>
                    <span class="distance-loading"
                      >Calculating distance...</span
                    >
                  </li>
                  <li>
                    <i class="fas fa-store text-primary me-2"></i>
                    <span class="distance-loading"
                      >Calculating distance...</span
                    >
                  </li>
                </ul>
              </div>
            </div>
            <div class="card-footer bg-transparent">
              <button
                class="btn btn-success w-100 mb-2 buy-online-btn"
                data-medicine-name="{{ medicine.name }}"
              >
                <i class="fas fa-shopping-cart me-2"></i> Buy Online
              </button>
              <button
                class="btn btn-outline-primary w-100 view-map-btn"
                data-medicine-name="{{ medicine.name }}"
              >
                <i class="fas fa-map-marker-alt me-2"></i> View on Map
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div
        class="modal fade"
        id="pharmacySelectionModal"
        tabindex="-1"
        aria-labelledby="pharmacySelectionModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 bg-light">
              <div class="w-100 text-center">
                <h5
                  class="modal-title text-dark fw-bold"
                  id="pharmacySelectionModalLabel"
                >
                  Buy Online
                </h5>
                <p class="text-muted mb-0 small">
                  Select your preferred pharmacy for
                  <span
                    id="selectedMedicineName"
                    class="fw-semibold text-primary"
                  ></span
                  ><br /><br />Some medicines may show "Out of Stock" on card
                  but other websites may have them in stock.
                </p>
              </div>
              <button
                type="button"
                class="btn-close position-absolute top-0 end-0 m-3"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body p-4">
              <div class="list-group border-0" id="pharmacyOptions">
              </div>
            </div>
            <div class="modal-footer border-0 bg-light">
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm"
                data-bs-dismiss="modal"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>

      <script>
        const medicineDistances = new Map();
        let userLocation = null;

        document.addEventListener("DOMContentLoaded", function () {
          initializeLocation();

          const locationFilter = document.getElementById("locationFilter");
          locationFilter.addEventListener("change", filterByLocation);

          document.querySelectorAll(".view-map-btn").forEach((button) => {
            button.addEventListener("click", function () {
              const medicineName = this.getAttribute("data-medicine-name");
              openMapForMedicine(medicineName);
            });
          });

          document.querySelectorAll(".buy-online-btn").forEach((button) => {
            button.addEventListener("click", function () {
              const medicineName = this.getAttribute("data-medicine-name");
              showPharmacySelectionModal(medicineName);
            });
          });

          updateMedicinePricesAndStockStatus();
        });

        function initializeLocation() {
          if (!navigator.geolocation) {
            updateAllMedicineDistances();
            return;
          }

          const options = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000,
          };

          navigator.geolocation.getCurrentPosition(
            function (position) {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              updateAllMedicineDistances();
            },
            function (error) {
              console.error("Error getting location:", error);
              updateAllMedicineDistances();
            },
            options
          );
        }

        function updateAllMedicineDistances() {
          const centerLat = userLocation ? userLocation.lat : 28.6139;
          const centerLng = userLocation ? userLocation.lng : 77.209;

          const pharmacyChains = [
            "Apollo Pharmacy",
            "MedPlus",
            "Wellness Forever",
            "Guardian Pharmacy",
            "Health & Glow",
            "PharmEasy Store",
            "1mg Pharmacy",
            "Netmeds Pharmacy",
            "Fortis Pharmacy",
            "Max Healthcare",
            "Local Medical Store",
            "City Pharmacy",
          ];

          const medicineCards = document.querySelectorAll(".medicine-card");

          medicineCards.forEach((card, index) => {
            const pharmacyList = card.querySelector(".list-unstyled");
            const pharmacyItems = pharmacyList.querySelectorAll("li");

            const distances = [];

            pharmacyItems.forEach((item, i) => {
              const distance = 0.5 + Math.random() * 7.5;
              distances.push(distance);

              const pharmacyName =
                pharmacyChains[
                  Math.floor(Math.random() * pharmacyChains.length)
                ];

              const distanceSpan = item.querySelector("span");
              distanceSpan.textContent = `${pharmacyName} (${distance.toFixed(
                1
              )} km)`;
              distanceSpan.classList.remove("distance-loading");
            });

            if (distances.length > 0) {
              const minDistance = Math.min(...distances);
              medicineDistances.set(`medicine-${index}`, minDistance);
              card.setAttribute("data-min-distance", minDistance);
            }
          });
        }

        function updateMedicinePricesAndStockStatus() {
          const medicineCards = document.querySelectorAll(".medicine-card");

          medicineCards.forEach((card) => {
            const medicineName = card.querySelector(".card-title").textContent;
            const priceElement = card.querySelector(".price-value");
            const priceLoading = card.querySelector(".price-loading");
            const stockBadge = card.querySelector(".stock-status");

            priceElement.style.display = "none";
            priceLoading.style.display = "inline";


            setTimeout(() => {
              const originalPrice = parseFloat(
                priceElement.textContent.replace("â‚¹", "")
              );
              const priceVariation = 0.8 + Math.random() * 0.4; 
              const newPrice = originalPrice * priceVariation;

              const isInStock = Math.random() < 0.8;

              priceElement.textContent = `â‚¹${newPrice.toFixed(2)}`;
              priceLoading.style.display = "none";
              priceElement.style.display = "inline";

              if (isInStock) {
                stockBadge.textContent = "In Stock";
                stockBadge.className =
                  "badge bg-success availability-badge stock-status";
              } else {
                stockBadge.textContent = "Out of Stock";
                stockBadge.className =
                  "badge bg-danger availability-badge stock-status";
              }
            }, 1000 + Math.random() * 2000); 
          });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
          const R = 6371;
          const dLat = ((lat2 - lat1) * Math.PI) / 180;
          const dLon = ((lon2 - lon1) * Math.PI) / 180;
          const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos((lat1 * Math.PI) / 180) *
              Math.cos((lat2 * Math.PI) / 180) *
              Math.sin(dLon / 2) *
              Math.sin(dLon / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
          const distance = R * c;
          return distance;
        }

        // Location Filter
        function filterByLocation() {
          const locationFilter = document.getElementById("locationFilter");
          const selectedValue = locationFilter.value;
          const medicineCards = document.querySelectorAll(".medicine-card");

          medicineCards.forEach((card) => {
            if (selectedValue === "all") {
              card.closest(".col").style.display = "";
            } else {
              const minDistance = card.getAttribute("data-min-distance");
              if (
                minDistance &&
                parseFloat(minDistance) <= parseFloat(selectedValue)
              ) {
                card.closest(".col").style.display = "";
              } else {
                card.closest(".col").style.display = "none";
              }
            }
          });
        }

        function openMapForMedicine(medicineName) {
          if (!userLocation) {
            alert("Please allow location access to find nearby pharmacies.");
            return;
          }

          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

          const searchQuery = `pharmacy medical store chemist ${medicineName}`;

          if (isIOS) {
            const url = `https://maps.apple.com/?q=${encodeURIComponent(
              searchQuery
            )}&sll=${userLocation.lat},${userLocation.lng}&z=12&t=m`;
            window.open(url, "_blank");
          } else {
            const url = `https://www.google.com/maps/search/${encodeURIComponent(
              searchQuery
            )}/@${userLocation.lat},${userLocation.lng},13z`;
            window.open(url, "_blank");
          }
        }

        function showPharmacySelectionModal(medicineName) {
          document.getElementById("selectedMedicineName").textContent =
            medicineName;

          const pharmacyOptions = document.getElementById("pharmacyOptions");
          pharmacyOptions.innerHTML = "";

          // Pharmacy websites
          const onlinePharmacies = [
            {
              name: "1mg",
              url: `https://www.1mg.com/search/all?name=${encodeURIComponent(
                medicineName
              )}`,
              icon: "fas fa-capsules",
              class: "pharmacy-1mg",
            },
            {
              name: "PharmEasy",
              url: `https://pharmeasy.in/search/all?name=${encodeURIComponent(
                medicineName
              )}`,
              icon: "fas fa-prescription-bottle",
              class: "pharmacy-pharmeasy",
            },
            {
              name: "Netmeds",
              url: `https://www.netmeds.com/products?q=${encodeURIComponent(
                medicineName
              )}`,
              icon: "fas fa-pills",
              class: "pharmacy-netmeds",
            },
            {
              name: "Apollo Pharmacy",
              url: `https://www.apollopharmacy.in/search-medicines/${encodeURIComponent(
                medicineName
              )}`,
              icon: "fas fa-hospital",
              class: "pharmacy-apollo",
            },
          ];

          onlinePharmacies.forEach((pharmacy) => {
            const optionElement = document.createElement("a");
            optionElement.href = "#";
            optionElement.className = `list-group-item list-group-item-action pharmacy-option ${pharmacy.class}`;
            optionElement.innerHTML = `
              <div class="d-flex align-items-center">
                <div class="pharmacy-icon text-white">
                  <i class="${pharmacy.icon}"></i>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-1 fw-semibold text-dark">${pharmacy.name}</h6>
                  <small class="text-muted">Available â€¢ Free delivery</small>
                </div>
                <div class="text-muted">
                  <i class="fas fa-chevron-right small"></i>
                </div>
              </div>
            `;

            optionElement.addEventListener("click", function (e) {
              e.preventDefault();
              window.open(pharmacy.url, "_blank");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("pharmacySelectionModal")
              );
              modal.hide();
            });

            pharmacyOptions.appendChild(optionElement);
          });

          const pharmacyModal = new bootstrap.Modal(
            document.getElementById("pharmacySelectionModal")
          );
          pharmacyModal.show();
        }

        function findNearbyPharmacies() {
          const apiKey = "AIzaSyBWevcMn1N8_jJbrTmOvIdFmmMoCBmkE4s";
          const radius = 5000;
          const types = ["pharmacy", "drugstore", "hospital", "health"];

          const url = `https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${
            userLocation.lat
          },${userLocation.lng}&radius=${radius}&type=${types.join(
            "|"
          )}&key=${apiKey}`;

          fetch(url)
            .then((response) => response.json())
            .then((data) => {
              if (data.results) {
                console.log("Nearby pharmacies:", data.results);
              }
            })
            .catch((error) => {
              console.error("Error fetching pharmacy data:", error);
            });
        }
      </script>

      <!-- No Results Message (Hidden by default) -->
      <div
        class="text-center py-5 {% if medicines %}d-none{% endif %}"
        id="noResults"
      >
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h3>No medicines found</h3>
        <p class="text-muted">Try adjusting your search criteria</p>
      </div>

      <!-- Pagination -->
      <nav aria-label="Medicine pagination" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if pagination.has_prev %}
          <li class="page-item">
            <a
              class="page-link"
              href="{{ url_for('medicines.medicines', page=pagination.prev_num) }}"
              aria-label="Previous"
            >
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {% else %}
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {% endif %} {% for page_num in pagination.iter_pages(left_edge=1,
          right_edge=1, left_current=2, right_current=2) %} {% if page_num %} {%
          if page_num == pagination.page %}
          <li class="page-item active">
            <a class="page-link" href="#">{{ page_num }}</a>
          </li>
          {% else %}
          <li class="page-item">
            <a
              class="page-link"
              href="{{ url_for('medicines.medicines', page=page_num) }}"
              >{{ page_num }}</a
            >
          </li>
          {% endif %} {% else %}
          <li class="page-item disabled">
            <a class="page-link" href="#">...</a>
          </li>
          {% endif %} {% endfor %} {% if pagination.has_next %}
          <li class="page-item">
            <a
              class="page-link"
              href="{{ url_for('medicines.medicines', page=pagination.next_num) }}"
              aria-label="Next"
            >
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {% else %}
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h5>HealthFinder</h5>
            <p>Your one-stop solution for all healthcare needs.</p>
          </div>
          <div class="col-md-3">
            <h5>Quick Links</h5>
            <ul class="list-unstyled">
              <li><a href="/" class="text-white">Home</a></li>
              <li><a href="/medicines" class="text-white">Medicines</a></li>
              <li><a href="/hospitals" class="text-white">Hospitals</a></li>
              <li><a href="/pharmacies" class="text-white">Pharmacies</a></li>
            </ul>
          </div>
          <div class="col-md-3">
            <h5>Contact</h5>
            <ul class="list-unstyled">
              <li>
                <i class="fas fa-envelope me-2"></i> info@healthfinder.com
              </li>
              <li><i class="fas fa-phone me-2"></i> +1 (555) 123-4567</li>
            </ul>
          </div>
        </div>
        <hr />
        <div class="text-center">
          <p class="mb-0">&copy; 2023 HealthFinder. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- search functionality -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("medicineSearch");
        const medicinesList = document.getElementById("medicinesList");
        const noResults = document.getElementById("noResults");

        searchInput.addEventListener("keyup", function () {
          const searchTerm = this.value.toLowerCase();
          const medicineCards = medicinesList.querySelectorAll(".col");
          let resultsFound = false;

          medicineCards.forEach(function (card) {
            const medicineName = card
              .querySelector(".card-title")
              .textContent.toLowerCase();
            if (medicineName.includes(searchTerm)) {
              card.style.display = "";
              resultsFound = true;
            } else {
              card.style.display = "none";
            }
          });

          if (resultsFound) {
            medicinesList.classList.remove("d-none");
            noResults.classList.add("d-none");
          } else {
            medicinesList.classList.add("d-none");
            noResults.classList.remove("d-none");
          }
        });
      });
    </script>
  </body>
</html>
